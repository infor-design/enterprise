CURRENT_DIR=$(shell pwd)

ORGANIZATION = hookandloop
IMAGE = enterprise-release
IMAGE_TAG = 1.0.2


ifneq (,$(wildcard ./.env))
	include .env
	export
endif


.PHONY: all
all: build tag push

.PHONY: build
build:
	DOCKER_BUILDKIT=1 docker build \
		--platform=linux/amd64 \
		-t $(IMAGE):$(IMAGE_TAG) \
		-f $(CURRENT_DIR)/Dockerfile .

.PHONY: tag
tag:
	docker tag $(IMAGE):$(IMAGE_TAG) $(ORGANIZATION)/$(IMAGE):$(IMAGE_TAG)

.PHONY: push
push:
	docker push $(ORGANIZATION)/$(IMAGE):$(IMAGE_TAG)

.PHONY: shell
shell :
	docker run -it --rm --name $(IMAGE) \
		--platform=linux/amd64 \
		--entrypoint /bin/bash \
		--env AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \
		--env AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \
		--env NPM_TOKEN=${NPM_TOKEN} \
		--env DRY_RUN=${DRY_RUN} \
		--env BRANCH=${BRANCH} \
		--env REPO_OWNER_NAME=${REPO_OWNER_NAME} \
		--env NPM_LATEST=${NPM_LATEST} \
		-v ${PWD}/build:/root/enterprise \
		-v ${PWD}/.gitconfig:/root/.gitconfig \
		-v ${PWD}/run.sh:/usr/src/run.sh \
		$(ORGANIZATION)/$(IMAGE):$(IMAGE_TAG)
